<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Pomodoro Timer</title>
  <style>
    /* 기존 스타일 그대로 유지 */
    /* ... (생략) ... */
    .option-group input[type="range"] {
      width: 100%;
    }
  </style>
</head>
<body>
<div id="pomodoroApp">
  <!-- 기존 UI 구성 그대로 유지 -->
</div>

<!-- 옵션 패널 -->
<div id="optionsPanel" style="display:none; margin-top: 20px; width: 100%; max-width: 400px;">
  <!-- 기존 설정들 유지 -->

  <button class="section-button" onclick="toggleSection('soundSettings')">알람 설정</button>
  <div id="soundSettings" class="section-content">
    <div class="option-group">
      <label for="volumeControl">알람 볼륨:</label>
      <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1">
    </div>
  </div>

  <!-- 기존 적용/닫기 버튼 유지 -->
</div>

<!-- 알람 오디오 -->
<audio id="alarmSound" loop>
  <source src="prod.chibi-wind.mp3" type="audio/mpeg">
</audio>

<script>
  let timeLeft;
  let timerInterval;
  let isRunning = false;
  let currentMode = 'pomodoro';
  const alarmAudio = document.getElementById('alarmSound');

  function switchMode(mode) {
    currentMode = mode;
    timeLeft = getDurationForMode(mode) * 60;
    updateTimerDisplay();
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`.tab.${mode}`).classList.add('active');
    stopAlarm();
    clearInterval(timerInterval);
    isRunning = false;
    document.getElementById('startBtn').innerText = '𝚂𝚃𝙰𝚁𝚃';
  }

  function toggleTimer() {
    if (isRunning) {
      clearInterval(timerInterval);
      isRunning = false;
      document.getElementById('startBtn').innerText = '𝚂𝚃𝙰𝚁𝚃';
    } else {
      isRunning = true;
      document.getElementById('startBtn').innerText = '𝙿𝙰𝚄𝚂𝙴';
      if (!timeLeft) {
        timeLeft = getDurationForMode(currentMode) * 60;
      }
      timerInterval = setInterval(updateTimer, 1000);
    }
  }

  function updateTimer() {
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      isRunning = false;
      document.getElementById('startBtn').innerText = '𝚂𝚃𝙰𝚁𝚃';
      const messages = JSON.parse(localStorage.getItem('userMessages') || '{}');
      const workDone = messages.work || '작업 끝!';
      const breakDone = messages.break || '휴식 끝!';
      alert(currentMode === 'pomodoro' ? workDone : breakDone);
      playAlarm();
    } else {
      timeLeft--;
      updateTimerDisplay();
    }
  }

  function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('timer').innerText = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  function resetTimer() {
    clearInterval(timerInterval);
    stopAlarm();
    isRunning = false;
    timeLeft = getDurationForMode(currentMode) * 60;
    updateTimerDisplay();
    document.getElementById('startBtn').innerText = '𝚂𝚃𝙰𝚁𝚃';
  }

  function toggleOptions() {
    const panel = document.getElementById('optionsPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  }

  function toggleSection(id) {
    const section = document.getElementById(id);
    section.classList.toggle('visible');
  }

  function applyOptions() {
    const styleMap = {
      '--bg-color': document.getElementById('bgColor').value,
      '--btn-color': document.getElementById('btnColor').value,
      '--btn-hover-color': document.getElementById('btnHoverColor').value,
      '--highlight-color': document.getElementById('highlightColor').value,
      '--btn-text-color': document.getElementById('btnTextColor').value,
      '--timer-color': document.getElementById('timerColor').value,
      '--btn-font-size': `${document.getElementById('btnFontSize').value}px`,
      '--timer-font-size': `${document.getElementById('timerFontSize').value}px`
    };

    for (const variable in styleMap) {
      document.documentElement.style.setProperty(variable, styleMap[variable]);
    }

    const times = {
      pomodoro: parseInt(document.getElementById('pomodoroTime').value),
      short: parseInt(document.getElementById('shortTime').value),
      long: parseInt(document.getElementById('longTime').value)
    };

    const messages = {
      work: document.getElementById('workDoneMessage').value,
      break: document.getElementById('breakDoneMessage').value
    };

    const volume = parseFloat(document.getElementById('volumeControl').value);
    alarmAudio.volume = volume;

    localStorage.setItem('userStyles', JSON.stringify(styleMap));
    localStorage.setItem('userTimes', JSON.stringify(times));
    localStorage.setItem('userMessages', JSON.stringify(messages));
    localStorage.setItem('alarmVolume', volume.toString());
  }

  function getDurationForMode(mode) {
    const savedTimes = JSON.parse(localStorage.getItem('userTimes') || '{}');
    const pomodoro = savedTimes.pomodoro || 25;
    const short = savedTimes.short || 5;
    const long = savedTimes.long || 15;
    return mode === 'pomodoro' ? pomodoro : mode === 'short' ? short : long;
  }

  function loadUserStyles() {
    const styleMap = JSON.parse(localStorage.getItem('userStyles') || '{}');
    for (const variable in styleMap) {
      document.documentElement.style.setProperty(variable, styleMap[variable]);
      const cleanId = variable.replace(/--/g, '').replace(/-/g, '');
      const input = document.querySelector(`#${cleanId}`);
      if (input) input.value = styleMap[variable].replace('px', '');
    }

    const times = JSON.parse(localStorage.getItem('userTimes') || '{}');
    document.getElementById('pomodoroTime').value = times.pomodoro || 25;
    document.getElementById('shortTime').value = times.short || 5;
    document.getElementById('longTime').value = times.long || 15;

    const messages = JSON.parse(localStorage.getItem('userMessages') || '{}');
    document.getElementById('workDoneMessage').value = messages.work || '작업 끝!';
    document.getElementById('breakDoneMessage').value = messages.break || '휴식 끝!';

    const savedVolume = parseFloat(localStorage.getItem('alarmVolume'));
    if (!isNaN(savedVolume)) {
      document.getElementById('volumeControl').value = savedVolume;
      alarmAudio.volume = savedVolume;
    }
  }

  function playAlarm() {
    alarmAudio.currentTime = 0;
    alarmAudio.play();
  }

  function stopAlarm() {
    alarmAudio.pause();
    alarmAudio.currentTime = 0;
  }

  loadUserStyles();
  switchMode(currentMode);
</script>
</body>
</html>
